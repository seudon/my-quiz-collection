<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>古生代古生物クイズ｜カンブリア紀〜ペルム紀（オフライン）</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="../../common/quiz-common.css" />
  </head>

  <body>
    <header>
      <h1>古生代古生物クイズ｜カンブリア紀〜ペルム紀（オフライン）</h1>
      <p>三葉虫、アノマロカリス、ダンクルオステウスなど、古生代を代表する古生物30種を学習。</p>
    </header>

    <main>
      <!-- Config Section -->
      <section class="card" id="config">
        <h2>設定</h2>
        <div class="row">
          <div>
            <label for="mode">モード</label>
            <select id="mode">
              <option value="multiple">4択問題（ランダム選択肢）</option>
            </select>
            <p class="tiny">生物名はWikipediaリンク付きで詳細を確認できます。</p>
          </div>
          <div>
            <label for="count">出題数</label>
            <input id="count" type="number" min="5" max="50" value="10" />
            <p class="tiny">推奨：10〜20問。短時間で反復。</p>
          </div>
          <div>
            <label for="scope">出題範囲</label>
            <select id="scope">
              <option value="all">全範囲（30種）</option>
              <optgroup label="時代別">
                <option value="cambrian">カンブリア紀</option>
                <option value="ordovician">オルドビス紀</option>
                <option value="silurian">シルル紀</option>
                <option value="devonian">デボン紀</option>
                <option value="carboniferous">石炭紀</option>
                <option value="permian">ペルム紀</option>
              </optgroup>
              <optgroup label="分類別">
                <option value="arthropod">節足動物系</option>
                <option value="fish">魚類</option>
                <option value="tetrapod">両生類・爬虫類</option>
                <option value="other">その他</option>
              </optgroup>
              <option value="popular">人気種のみ</option>
            </select>
            <p class="tiny">時代別・分類別に絞って練習できます。</p>
          </div>
        </div>
        <div class="row">
          <button id="startBtn">クイズ開始</button>
        </div>
        <p class="tiny">
          ヒント：
          <span class="badge">カンブリア紀＝約5.4億〜4.9億年前</span>
          <span class="badge">三葉虫＝古生代を代表する節足動物</span>
          <span class="badge">ペルム紀末＝史上最大の大量絶滅</span>
        </p>

        <details>
          <summary>収録データ（30種の古生代古生物）</summary>
          <ul>
            <li><strong>節足動物系:</strong> アノマロカリス、ハルキゲニア、三葉虫、メガネウラなど</li>
            <li><strong>魚類:</strong> ダンクルオステウス、ティクターリク、ヘリコプリオンなど</li>
            <li><strong>両生類・爬虫類:</strong> ディメトロドン、ディプロカウルス、メソサウルスなど</li>
            <li><strong>その他:</strong> レピドデンドロン（植物）、フズリナ（原生生物）など</li>
          </ul>
          <p class="tiny">選択肢に表示される生物名をクリックすると、Wikipediaで詳しい情報を確認できます。</p>
        </details>
      </section>

      <!-- Quiz Section -->
      <div id="quizWrapper" class="hidden">
        <!-- Progress Bar -->
        <div class="progress-container">
          <div class="progress-text">
            問題 <span id="currentQ">1</span> / <span id="totalQ">10</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
        </div>

        <!-- Quiz Container -->
        <div class="quiz-container" id="quizContainer">
          <!-- Questions will be inserted here dynamically -->
        </div>

        <!-- Navigation -->
        <div class="navigation">
          <button id="exitBtn" class="danger">結果を見る</button>
          <button id="nextBtn" class="primary">次へ</button>
        </div>
      </div>

      <!-- Results Section -->
      <div id="resultsWrapper" class="hidden">
        <div class="results-container">
          <div class="card">
            <div class="score-summary">
              <div class="score-label">あなたのスコア</div>
              <div class="score-number" id="scoreNumber">0 / 10</div>
              <div class="score-label" id="scorePercent">正解率: 0%</div>
            </div>

            <div class="action-buttons">
              <button id="restartBtn">最初からやり直す</button>
              <button id="newQuizBtn" class="secondary">設定を変更して新規クイズ</button>
              <button id="reviewWrongBtn" class="warn">間違いだけ復習</button>
              <button id="reviewAllBtn" class="secondary">全問題をレビュー</button>
            </div>
          </div>

          <!-- Wrong Answers Section -->
          <div id="wrongSection" class="card result-section">
            <h3>間違えた問題</h3>
            <div id="wrongList"></div>
          </div>

          <!-- All Answers Section -->
          <div id="allSection" class="card result-section hidden">
            <h3>全問題の回答履歴</h3>
            <div id="allList"></div>
          </div>
        </div>
      </div>

      <div class="footer">
        <p>保存方法：このページを「.html」ファイルとして保存→ブラウザで開くだけ。</p>
      </div>
    </main>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal-overlay hidden">
      <div class="modal">
        <h3>確認</h3>
        <p id="modalMessage">本当に終了して結果を見ますか？</p>
        <div class="modal-actions">
          <button id="modalCancel" class="secondary">キャンセル</button>
          <button id="modalConfirm" class="warn">結果を見る</button>
        </div>
      </div>
    </div>

    <script src="../../common/quiz-common.js"></script>
    <script>
      // 古生代古生物データ
      const paleozoicCreaturesData = [
        {
          id: "anomalocaris",
          name: "アノマロカリス",
          scientific: "Anomalocaris",
          category: "節足動物幹群（ラディオドンタ類）",
          period: "カンブリア紀",
          feature: "カンブリア海の頂点捕食者。大きな複眼と掴む付属肢を持つ。",
          wiki: "https://en.wikipedia.org/wiki/Anomalocaris",
          type: ["arthropod"],
          era: ["cambrian"],
          popular: true
        },
        {
          id: "arthropleura",
          name: "アースロプレウラ",
          scientific: "Arthropleura",
          category: "節足動物（多足類）",
          period: "石炭紀〜ペルム紀",
          feature: "史上最大級の陸生節足動物。多数の脚を持つ巨大生物。",
          wiki: "https://en.wikipedia.org/wiki/Arthropleura",
          type: ["arthropod"],
          era: ["carboniferous", "permian"],
          popular: true
        },
        {
          id: "opabinia",
          name: "オパビニア",
          scientific: "Opabinia regalis",
          category: "節足動物幹群",
          period: "カンブリア紀",
          feature: "五つの眼と長い吻を持つ特異な古生物。",
          wiki: "https://en.wikipedia.org/wiki/Opabinia",
          type: ["arthropod"],
          era: ["cambrian"],
          popular: true
        },
        {
          id: "kylinxia",
          name: "カイリンシア",
          scientific: "Kylinxia",
          category: "節足動物幹群",
          period: "カンブリア紀",
          feature: "節足動物進化の中間的特徴を示す重要化石。",
          wiki: "https://en.wikipedia.org/wiki/Kylinxia",
          type: ["arthropod"],
          era: ["cambrian"],
          popular: false
        },
        {
          id: "cephalaspis",
          name: "ケファラスピス",
          scientific: "Cephalaspis",
          category: "魚類（無顎類）",
          period: "シルル紀〜デボン紀",
          feature: "頭部に盾状の装甲を持つ底生魚。",
          wiki: "https://en.wikipedia.org/wiki/Cephalaspis",
          type: ["fish"],
          era: ["silurian", "devonian"],
          popular: false
        },
        {
          id: "sacabambaspis",
          name: "サカバンバスピス",
          scientific: "Sacabambaspis",
          category: "魚類（無顎類）",
          period: "オルドビス紀",
          feature: "眼が前方にある原始的な装甲魚。",
          wiki: "https://en.wikipedia.org/wiki/Sacabambaspis",
          type: ["fish"],
          era: ["ordovician"],
          popular: true
        },
        {
          id: "sidneyia",
          name: "シドニーア",
          scientific: "Sidneyia",
          category: "節足動物",
          period: "カンブリア紀",
          feature: "硬い殻を砕いて捕食したとされる底生動物。",
          wiki: "https://en.wikipedia.org/wiki/Sidneyia",
          type: ["arthropod"],
          era: ["cambrian"],
          popular: false
        },
        {
          id: "skania",
          name: "スカニア",
          scientific: "Skania",
          category: "節足動物",
          period: "カンブリア紀",
          feature: "小型で殻と棘を持つ古節足動物。",
          wiki: "https://en.wikipedia.org/wiki/Skania",
          type: ["arthropod"],
          era: ["cambrian"],
          popular: false
        },
        {
          id: "dunkleosteus",
          name: "ダンクルオステウス",
          scientific: "Dunkleosteus",
          category: "魚類（板皮類）",
          period: "デボン紀",
          feature: "史上最大級の肉食魚。刃状の骨板を持つ。",
          wiki: "https://en.wikipedia.org/wiki/Dunkleosteus",
          type: ["fish"],
          era: ["devonian"],
          popular: true
        },
        {
          id: "dimetrodon",
          name: "ディメトロドン",
          scientific: "Dimetrodon",
          category: "単弓類",
          period: "ペルム紀",
          feature: "背中の帆が特徴。恐竜ではなく哺乳類に近縁。",
          wiki: "https://ja.wikipedia.org/wiki/ディメトロドン",
          type: ["tetrapod"],
          era: ["permian"],
          popular: true
        },
        {
          id: "diplocaulus",
          name: "ディプロカウルス",
          scientific: "Diplocaulus",
          category: "両生類",
          period: "ペルム紀",
          feature: "ブーメラン状の頭部を持つ特異な水生両生類。",
          wiki: "https://en.wikipedia.org/wiki/Diplocaulus",
          type: ["tetrapod"],
          era: ["permian"],
          popular: true
        },
        {
          id: "tiktaalik",
          name: "ティクターリク",
          scientific: "Tiktaalik",
          category: "魚類（肉鰭類）",
          period: "デボン紀",
          feature: "魚と四肢動物の中間的特徴を持つ移行化石。",
          wiki: "https://ja.wikipedia.org/wiki/ティクターリク",
          type: ["fish"],
          era: ["devonian"],
          popular: true
        },
        {
          id: "naraoia",
          name: "ナラオイア",
          scientific: "Naraoia",
          category: "節足動物",
          period: "カンブリア紀",
          feature: "二枚貝状の外見を持つ三葉虫近縁種。",
          wiki: "https://en.wikipedia.org/wiki/Naraoia",
          type: ["arthropod"],
          era: ["cambrian"],
          popular: false
        },
        {
          id: "nectocaris",
          name: "ネクトカリス",
          scientific: "Nectocaris",
          category: "軟体動物（頭足類幹群）",
          period: "カンブリア紀",
          feature: "殻を持たない初期頭足類。",
          wiki: "https://en.wikipedia.org/wiki/Nectocaris",
          type: ["other"],
          era: ["cambrian"],
          popular: false
        },
        {
          id: "nautiloidea",
          name: "ノーチロイド",
          scientific: "Nautiloidea",
          category: "軟体動物（頭足類）",
          period: "オルドビス紀〜ペルム紀",
          feature: "オウムガイ類の祖先群。",
          wiki: "https://en.wikipedia.org/wiki/Nautiloidea",
          type: ["other"],
          era: ["ordovician", "silurian", "devonian", "carboniferous", "permian"],
          popular: false
        },
        {
          id: "hallucigenia",
          name: "ハルキゲニア",
          scientific: "Hallucigenia",
          category: "節足動物幹群",
          period: "カンブリア紀",
          feature: "上下が誤解されていた奇妙な姿の生物。",
          wiki: "https://en.wikipedia.org/wiki/Hallucigenia",
          type: ["arthropod"],
          era: ["cambrian"],
          popular: true
        },
        {
          id: "pikaia",
          name: "パイカイア",
          scientific: "Pikaia",
          category: "脊索動物",
          period: "カンブリア紀",
          feature: "脊椎動物の祖先とされる重要化石。",
          wiki: "https://en.wikipedia.org/wiki/Pikaia",
          type: ["other"],
          era: ["cambrian"],
          popular: true
        },
        {
          id: "hyoliths",
          name: "ヒオリテス",
          scientific: "Hyoliths",
          category: "分類未確定",
          period: "カンブリア紀",
          feature: "円錐形の殻を持つ謎の古生物群。",
          wiki: "https://en.wikipedia.org/wiki/Hyolith",
          type: ["other"],
          era: ["cambrian"],
          popular: false
        },
        {
          id: "fusulinida",
          name: "フズリナ",
          scientific: "Fusulinida",
          category: "原生生物（有孔虫）",
          period: "石炭紀〜ペルム紀",
          feature: "示準化石として重要な微化石。",
          wiki: "https://en.wikipedia.org/wiki/Fusulinida",
          type: ["other"],
          era: ["carboniferous", "permian"],
          popular: false
        },
        {
          id: "pterygotus",
          name: "プテリギオトゥス",
          scientific: "Pterygotus",
          category: "節足動物（ウミサソリ類）",
          period: "シルル紀〜デボン紀",
          feature: "大型の捕食性ウミサソリ。",
          wiki: "https://en.wikipedia.org/wiki/Pterygotus",
          type: ["arthropod"],
          era: ["silurian", "devonian"],
          popular: true
        },
        {
          id: "helicoprion",
          name: "ヘリコプリオン",
          scientific: "Helicoprion",
          category: "軟骨魚類",
          period: "ペルム紀",
          feature: "渦巻き状の歯列を持つ古代サメ。",
          wiki: "https://en.wikipedia.org/wiki/Helicoprion",
          type: ["fish"],
          era: ["permian"],
          popular: true
        },
        {
          id: "marrella",
          name: "マルレラ",
          scientific: "Marrella",
          category: "節足動物",
          period: "カンブリア紀",
          feature: "バージェス頁岩で最も多産する化石。",
          wiki: "https://en.wikipedia.org/wiki/Marrella",
          type: ["arthropod"],
          era: ["cambrian"],
          popular: false
        },
        {
          id: "meganeura",
          name: "メガネウラ",
          scientific: "Meganeura",
          category: "昆虫",
          period: "石炭紀",
          feature: "翼開長70cm級の巨大トンボ。",
          wiki: "https://ja.wikipedia.org/wiki/メガネウラ",
          type: ["arthropod"],
          era: ["carboniferous"],
          popular: true
        },
        {
          id: "mesosaurus",
          name: "メソサウルス",
          scientific: "Mesosaurus",
          category: "爬虫類",
          period: "ペルム紀",
          feature: "大陸移動説の重要証拠となった水生爬虫類。",
          wiki: "https://en.wikipedia.org/wiki/Mesosaurus",
          type: ["tetrapod"],
          era: ["permian"],
          popular: true
        },
        {
          id: "eusthenopteron",
          name: "ユーステノプテロン",
          scientific: "Eusthenopteron",
          category: "魚類（肉鰭類）",
          period: "デボン紀",
          feature: "四肢動物に近いヒレ骨格を持つ魚。",
          wiki: "https://en.wikipedia.org/wiki/Eusthenopteron",
          type: ["fish"],
          era: ["devonian"],
          popular: false
        },
        {
          id: "eurypterus",
          name: "ユーロプテルス",
          scientific: "Eurypterus",
          category: "節足動物（ウミサソリ類）",
          period: "シルル紀",
          feature: "ウミサソリ類の代表種。",
          wiki: "https://en.wikipedia.org/wiki/Eurypterus",
          type: ["arthropod"],
          era: ["silurian"],
          popular: false
        },
        {
          id: "radiodonta",
          name: "ラディオドンタ類",
          scientific: "Radiodonta",
          category: "節足動物幹群",
          period: "カンブリア紀",
          feature: "初期の大型捕食動物群。",
          wiki: "https://en.wikipedia.org/wiki/Radiodonta",
          type: ["arthropod"],
          era: ["cambrian"],
          popular: false
        },
        {
          id: "lystrosaurus",
          name: "リストロサウルス",
          scientific: "Lystrosaurus",
          category: "単弓類",
          period: "ペルム紀",
          feature: "大量絶滅を生き延びた代表的動物。",
          wiki: "https://ja.wikipedia.org/wiki/リストロサウルス",
          type: ["tetrapod"],
          era: ["permian"],
          popular: true
        },
        {
          id: "lepidodendron",
          name: "レピドデンドロン",
          scientific: "Lepidodendron",
          category: "植物",
          period: "石炭紀",
          feature: "石炭形成の主役となった巨大樹木。",
          wiki: "https://ja.wikipedia.org/wiki/レピドデンドロン",
          type: ["other"],
          era: ["carboniferous"],
          popular: true
        },
        {
          id: "trilobita",
          name: "三葉虫",
          scientific: "Trilobita",
          category: "節足動物",
          period: "カンブリア紀〜ペルム紀",
          feature: "古生代を代表する示準化石群。",
          wiki: "https://ja.wikipedia.org/wiki/三葉虫",
          type: ["arthropod"],
          era: ["cambrian", "ordovician", "silurian", "devonian", "carboniferous", "permian"],
          popular: true
        }
      ];

      // 古生代古生物クイズエンジン（QuizEngineを継承）
      class PaleozoicCreaturesQuizEngine extends QuizEngine {
        constructor() {
          super(paleozoicCreaturesData, {
            title: '古生代古生物クイズ',
            description: 'カンブリア紀〜ペルム紀の古生物'
          });
        }

        makeQuestion(item, mode, focus) {
          let prompt = "", correctValue = "", choices = [], type = "";

          // 問題タイプの決定
          const questionTypes = ["name_to_period", "period_to_name", "feature_to_name", "name_to_category", "name_to_feature", "scientific_to_name"];
          type = this.shuffle(questionTypes)[0];

          switch (type) {
            case "name_to_period":
              prompt = `「${item.name}」が生息していた時代は？`;
              correctValue = item.period;
              choices = this.generatePeriodChoices(item.period);
              break;

            case "period_to_name":
              prompt = `${item.period}に生息していた「${item.feature}」は？`;
              correctValue = item.name;
              choices = this.generateCreatureChoices(item);
              break;

            case "feature_to_name":
              prompt = `「${item.feature}」に該当する古生物は？`;
              correctValue = item.name;
              choices = this.generateCreatureChoices(item);
              break;

            case "name_to_category":
              prompt = `「${item.name}」の分類は？`;
              correctValue = item.category;
              choices = this.generateCategoryChoices(item.category);
              break;

            case "name_to_feature":
              prompt = `「${item.name}」の特徴は？`;
              correctValue = item.feature;
              choices = this.generateFeatureChoices(item);
              break;

            case "scientific_to_name":
              prompt = `学名「${item.scientific}」の和名は？`;
              correctValue = item.name;
              choices = this.generateCreatureChoices(item);
              break;
          }

          const typeLabel =
            type === "name_to_period" ? '名前→年代' :
            type === "period_to_name" ? '年代→名前' :
            type === "feature_to_name" ? '特徴→名前' :
            type === "name_to_category" ? '名前→分類' :
            type === "name_to_feature" ? '名前→特徴' : '学名→名前';

          return {
            id: item.id + "-" + Math.random().toString(36).slice(2),
            item,
            prompt,
            correct: correctValue,
            choices,
            type,
            mode,
            badges: [item.name, typeLabel],
            hint: `${item.period} | ${item.category}`,
            placeholder: ""
          };
        }

        generatePeriodChoices(correctPeriod) {
          const periods = [
            "カンブリア紀",
            "オルドビス紀",
            "シルル紀",
            "デボン紀",
            "石炭紀",
            "ペルム紀",
            "石炭紀〜ペルム紀",
            "シルル紀〜デボン紀",
            "オルドビス紀〜ペルム紀",
            "カンブリア紀〜ペルム紀"
          ];

          let choices = [correctPeriod];
          const availablePeriods = periods.filter(p => p !== correctPeriod);

          while (choices.length < 4 && availablePeriods.length > 0) {
            const randomIndex = Math.floor(Math.random() * availablePeriods.length);
            choices.push(availablePeriods.splice(randomIndex, 1)[0]);
          }

          return this.shuffle(choices);
        }

        generateCreatureChoices(correctItem) {
          let choices = [{ text: correctItem.name, wiki: correctItem.wiki }];
          const otherCreatures = this.quizData.filter(c => c.id !== correctItem.id);

          while (choices.length < 4 && otherCreatures.length > 0) {
            const randomIndex = Math.floor(Math.random() * otherCreatures.length);
            const creature = otherCreatures.splice(randomIndex, 1)[0];
            choices.push({ text: creature.name, wiki: creature.wiki });
          }

          return this.shuffle(choices);
        }

        generateCategoryChoices(correctCategory) {
          const categories = [
            "節足動物幹群（ラディオドンタ類）",
            "節足動物（多足類）",
            "節足動物",
            "魚類（無顎類）",
            "魚類（板皮類）",
            "魚類（肉鰭類）",
            "軟骨魚類",
            "単弓類",
            "両生類",
            "爬虫類",
            "軟体動物（頭足類）",
            "脊索動物",
            "原生生物（有孔虫）",
            "植物",
            "昆虫"
          ];

          let choices = [correctCategory];
          const availableCategories = categories.filter(c => c !== correctCategory);

          while (choices.length < 4 && availableCategories.length > 0) {
            const randomIndex = Math.floor(Math.random() * availableCategories.length);
            choices.push(availableCategories.splice(randomIndex, 1)[0]);
          }

          return this.shuffle(choices);
        }

        generateFeatureChoices(correctItem) {
          let choices = [correctItem.feature];
          const otherCreatures = this.quizData.filter(c => c.id !== correctItem.id);

          while (choices.length < 4 && otherCreatures.length > 0) {
            const randomIndex = Math.floor(Math.random() * otherCreatures.length);
            const creature = otherCreatures.splice(randomIndex, 1)[0];
            choices.push(creature.feature);
          }

          return this.shuffle(choices);
        }

        buildQuestions() {
          const scope = this.scopeSelect.value;
          let pool = this.quizData.filter(item => {
            if (scope === "all") return true;
            if (scope === "popular") return item.popular === true;

            // 時代別フィルター
            if (["cambrian", "ordovician", "silurian", "devonian", "carboniferous", "permian"].includes(scope)) {
              return item.era.includes(scope);
            }

            // 分類別フィルター
            if (["arthropod", "fish", "tetrapod", "other"].includes(scope)) {
              return item.type.includes(scope);
            }

            return true;
          });

          if (pool.length === 0) {
            alert("選択された範囲にデータがありません");
            return;
          }

          this.questions = [];
          for (let i = 0; i < this.questionCount; i++) {
            const item = pool[Math.floor(Math.random() * pool.length)];
            this.questions.push(this.makeQuestion(item, this.mode, "mixed"));
          }
        }

        displayQuestion() {
          const q = this.questions[this.currentQuestionIndex];

          // 問題文を表示
          const questionHtml = `
            <div class="card question-card">
              <div class="badges">
                ${q.badges.map(b => `<span class="badge">${b}</span>`).join('')}
              </div>
              <div class="question-text">${q.prompt}</div>
              ${q.hint ? `<div class="hint-text">💡 ${q.hint}</div>` : ''}
            </div>
          `;

          this.quizContainer.innerHTML = questionHtml;

          // 選択肢を表示（Wikipedia リンク対応）
          if (this.mode === "multiple") {
            const choicesHtml = q.choices.map((choice, idx) => {
              if (typeof choice === "object" && choice.wiki) {
                // Wikipedia リンク付き選択肢
                return `
                  <div class="choice-btn" data-answer="${choice.text}">
                    <span class="choice-text">${choice.text}</span>
                    <a href="${choice.wiki}" target="_blank" class="wiki-link" onclick="event.stopPropagation()">🔗</a>
                  </div>
                `;
              } else {
                // 通常の選択肢
                const text = typeof choice === "object" ? choice.text : choice;
                return `<div class="choice-btn" data-answer="${text}">${text}</div>`;
              }
            }).join('');

            this.quizContainer.innerHTML += `<div class="choices-container">${choicesHtml}</div>`;

            // 選択肢のクリックイベント
            document.querySelectorAll('.choice-btn').forEach(btn => {
              btn.addEventListener('click', () => {
                const answer = btn.getAttribute('data-answer');
                this.handleAnswer(answer);
              });
            });
          }
        }

        compareAnswer(userAnswer, correctAnswer) {
          const normalize = (str) => {
            return str
              .replace(/\s+/g, "")
              .replace(/[〜～]/g, "〜")
              .toLowerCase();
          };
          return normalize(userAnswer) === normalize(correctAnswer);
        }
      }

      // クイズエンジン初期化
      const quizEngine = new PaleozoicCreaturesQuizEngine();
    </script>
  </body>
</html>
